<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Improvement Tracker - Korean Learning Progress</title>
    
    <!-- Google Fonts for Korean support -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header-logo {
            max-width: 200px;
            height: auto;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 2.5em;
            font-weight: 300;
            letter-spacing: 2px;
            margin-bottom: 10px;
        }

        .header .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
            font-weight: 300;
        }

        .upload-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }

        .character-images {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .character-images img {
            width: 50px;
            height: 50px;
            object-fit: contain;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }

        .character-images img:hover {
            opacity: 1;
        }

        .file-input-wrapper {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .file-input-label {
            background: white;
            border: 2px dashed #667eea;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #667eea;
        }

        .file-input-label:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        #fileInput {
            display: none;
        }

        .process-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .process-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .process-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .new-student-btn {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .new-student-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(17, 153, 142, 0.4);
        }

        .new-student-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .file-input-label.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .blank-fill-section {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .blank-fill-input {
            padding: 10px 15px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 15px;
            width: 100px;
            text-align: center;
        }
        
        .blank-fill-input:disabled {
            background: #e0e0e0;
            border-color: #999;
            color: #666;
            cursor: not-allowed;
        }

        .blank-fill-label {
            font-weight: 500;
            color: #667eea;
        }

        .mode-selector {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .mode-btn {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 10px 30px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .mode-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .mode-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #e0e0e0;
            color: #999;
            border-color: #ccc;
        }

        .comparison-options {
            display: none;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .comparison-options.active {
            display: flex;
        }

        .comparison-btn {
            background: white;
            color: #11998e;
            border: 2px solid #11998e;
            padding: 8px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .comparison-btn.active {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .comparison-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(17, 153, 142, 0.3);
        }

        .download-section {
            padding: 20px 30px;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
        }

        .download-btn {
            background: white;
            color: #11998e;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .download-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .download-all-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .download-status {
            color: white;
            font-weight: 500;
            display: none;
        }

        .student-tabs {
            display: flex;
            padding: 20px 30px 0;
            gap: 10px;
            flex-wrap: wrap;
            border-bottom: 2px solid #f0f0f0;
        }

        .student-tab {
            padding: 12px 24px;
            background: #f8f9fa;
            border: none;
            border-radius: 10px 10px 0 0;
            cursor: pointer;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
        }

        .student-tab.active {
            background: white;
            color: #667eea;
            transform: translateY(-2px);
        }

        .student-tab:hover:not(.active) {
            background: #e8e9ea;
        }

        .content {
            padding: 30px;
        }

        .student-report {
            display: none;
        }

        .student-report.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transform: translateY(0);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        .stat-card .label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card .value {
            font-size: 2.5em;
            font-weight: 300;
            margin-bottom: 5px;
        }

        .stat-card .change {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .stat-card .description {
            font-size: 0.85em;
            opacity: 0.85;
            margin-top: 8px;
            font-style: italic;
        }

        .stat-card.positive {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .stat-card.negative {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        }

        .stat-card.gold {
            background: linear-gradient(135deg, #f9d423 0%, #ff4e50 100%);
        }

        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            position: relative;
            max-height: 550px;
            overflow: hidden;
        }
        
        .chart-container canvas {
            max-height: 500px !important;
            height: auto !important;
        }

        .chart-title {
            font-size: 1.4em;
            color: #333;
            margin-bottom: 20px;
            font-weight: 300;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-title .emoji {
            font-size: 1.2em;
        }
        
        canvas {
            display: block !important;
            box-sizing: border-box !important;
            height: 100% !important;
            width: 100% !important;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .charts-grid .chart-container {
            height: 350px;
            display: flex;
            flex-direction: column;
        }
        
        .chart-wrapper {
            position: relative;
            flex: 1;
            min-height: 250px;
            max-height: 300px;
        }

        @media (max-width: 968px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .charts-grid .chart-container {
                height: 300px;
            }
            
            .chart-wrapper {
                max-height: 250px;
            }
        }

        .details-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-top: 30px;
        }

        .details-title {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 20px;
            font-weight: 400;
        }

        .character-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
        }

        .mastery-header {
            text-align: center;
            font-weight: 700;
            font-size: 0.9em;
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 5px;
        }

        .mastery-header.mastered {
            color: #f9d423;
            background: rgba(249, 212, 35, 0.15);
        }

        .mastery-header.so-close {
            color: #38ef7d;
            background: rgba(56, 239, 125, 0.15);
        }

        .mastery-header.keep-studying {
            color: #FFC107;
            background: rgba(255, 193, 7, 0.15);
        }

        .mastery-header.priority-review {
            color: #f45c43;
            background: rgba(244, 92, 67, 0.15);
        }

        .character-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .character-card.score-gold {
            border-color: #f9d423;
            background: linear-gradient(135deg, rgba(249, 212, 35, 0.1) 0%, rgba(255, 78, 80, 0.1) 100%);
            -webkit-box-shadow: 0px 0px 27px 3px rgba(255,200,33,0.99);
            -moz-box-shadow: 0px 0px 27px 3px rgba(255,200,33,0.99);
            box-shadow: 0px 0px 27px 3px rgba(255,200,33,0.99);
        }

        .character-card.score-high {
            border-color: #38ef7d;
            background: linear-gradient(135deg, rgba(17, 153, 142, 0.05) 0%, rgba(56, 239, 125, 0.05) 100%);
        }

        .character-card.score-medium {
            border-color: #FFC107;
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.05) 0%, rgba(255, 200, 0, 0.05) 100%);
        }

        .character-card.score-low {
            border-color: #f45c43;
            background: linear-gradient(135deg, rgba(235, 51, 73, 0.05) 0%, rgba(244, 92, 67, 0.05) 100%);
        }

        .character-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .character-name {
            font-size: 2em;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .character-progress {
            font-size: 0.85em;
            color: #666;
            line-height: 1.5;
        }

        .character-improvement {
            font-size: 1.1em;
            font-weight: 600;
            margin-top: 8px;
        }

        .improvement-gold {
            color: #f9d423;
        }

        .improvement-high {
            color: #38ef7d;
        }

        .improvement-medium {
            color: #FFC107;
        }

        .improvement-low {
            color: #f45c43;
        }

        .teacher-recommendations {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #667eea;
        }

        .teacher-recommendations h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .teacher-recommendations p {
            color: #333;
            line-height: 1.8;
            font-size: 1em;
        }

        .comparison-section {
            background: white;
            display: none;
        }

        .comparison-section.active {
            display: block;
        }

        #loadingMessage {
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-size: 1.1em;
            display: none;
        }

        .spinner {
            border: 3px solid rgba(102, 126, 234, 0.1);
            border-radius: 50%;
            border-top: 3px solid #667eea;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 80px 30px;
            color: #667eea;
        }

        .empty-state-icon {
            font-size: 5em;
            margin-bottom: 20px;
        }

        .empty-state h2 {
            font-size: 2em;
            margin-bottom: 15px;
            font-weight: 300;
        }

        .empty-state p {
            font-size: 1.2em;
            color: #888;
            max-width: 600px;
            margin: 0 auto;
        }

        .priority-notice {
            background: linear-gradient(135deg, rgba(235, 51, 73, 0.1) 0%, rgba(244, 92, 67, 0.1) 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #f45c43;
            font-weight: 600;
            color: #f45c43;
            font-size: 1.1em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="https://cdn.shopify.com/s/files/1/0674/6747/7282/files/logo555.png?v=1757969221" alt="Korean Learning Logo" class="header-logo">
            <h1>üìö KoreanLearnin Progress Tracker</h1>
            <div class="subtitle">Student Improvement Analytics</div>
        </div>

        <div class="upload-section">
            <div class="character-images">
                <img src="https://cdn.shopify.com/s/files/1/0674/6747/7282/files/4b45bdfbd4b83c4f97f7c58cd8e49623_31e72055-468c-4c6f-82a0-f79734707937.png?v=1731621340" alt="Character 1">
                <img src="https://cdn.shopify.com/s/files/1/0674/6747/7282/files/9025db2a75c6ad48c96d559511317306.png?v=1731621340" alt="Character 2">
                <img src="https://cdn.shopify.com/s/files/1/0674/6747/7282/files/f27348ba976bcb866a09d5e281c36e55.png?v=1731621339" alt="Character 3">
                <img src="https://cdn.shopify.com/s/files/1/0674/6747/7282/files/96af0d4d3db9c09d03897cd19f41ec8c.png?v=1731621340" alt="Character 4">
                <img src="https://cdn.shopify.com/s/files/1/0674/6747/7282/files/ba361cb80f08dfce6c255ebc1dc8b0aa.png?v=1731621340" alt="Character 5">
                <img src="https://cdn.shopify.com/s/files/1/0674/6747/7282/files/71dc38903bd85b1734e6c742fb694eec.png?v=1731621340" alt="Character 6">
            </div>
            <div class="file-input-wrapper">
                <label for="fileInput" class="file-input-label" id="fileInputLabel">
                    üìÇ Choose CSV Files (Max 10)
                </label>
                <input type="file" id="fileInput" multiple accept=".csv">
                <button id="processBtn" class="process-btn" onclick="processFiles()">
                    üöÄ Analyze Progress
                </button>
                <button id="newStudentBtn" class="new-student-btn" onclick="resetForNewStudent()" disabled>
                    üîÑ New Student
                </button>
            </div>
            <div class="blank-fill-section">
                <span class="blank-fill-label">Fill blank cells with:</span>
                <input type="number" id="blankFill1" class="blank-fill-input" placeholder="Option 1" min="0" max="10" step="1">
                <span class="blank-fill-label">and/or</span>
                <input type="number" id="blankFill2" class="blank-fill-input" placeholder="Option 2" min="0" max="10" step="1">
                <span class="blank-fill-label" style="font-size: 0.9em; color: #888;">(Leave both empty to skip blank cells)</span>
            </div>
            <div class="mode-selector">
                <button class="mode-btn active" onclick="setMode('daily')" id="dailyBtn">üìÖ Daily</button>
                <button class="mode-btn" onclick="setMode('consecutive')" id="consecutiveBtn">üìÜ Consecutive</button>
                <button class="mode-btn" onclick="setMode('comparison')" id="comparisonBtn">üìä Comparison Chart</button>
            </div>
            <div class="blank-fill-section" id="dailyWeekSelector" style="display: flex;">
                <span class="blank-fill-label">Analyze which week?</span>
                <input type="text" id="dailyWeekInput" class="blank-fill-input" placeholder="week 1" style="width: 150px;">
                <span class="blank-fill-label" style="font-size: 0.9em; color: #888;">(e.g., "week 1", "2", "week 3")</span>
            </div>
            <div class="comparison-options" id="comparisonOptions">
                <button class="comparison-btn active" onclick="setComparisonType('day1')" id="day1Btn">vs Day 1</button>
                <button class="comparison-btn" onclick="setComparisonType('month')" id="monthBtn">vs 1 Month Ago</button>
                <button class="comparison-btn" onclick="setComparisonType('week')" id="weekBtn">vs Week Before</button>
            </div>
            <div id="loadingMessage">
                <div class="spinner"></div>
                Processing student data...
            </div>
        </div>

        <div class="student-tabs" id="studentTabs"></div>
        
        <div class="content" id="content">
            <div class="empty-state">
                <div class="empty-state-icon">üìä</div>
                <h2>Welcome to the KoreanLearnin Progress Tracker</h2>
                <p>Please upload CSV files to get started! Select one or more student progress files and click "Analyze Progress" to view detailed insights and analytics.</p>
            </div>
            <div id="reportsContainer"></div>
            <div id="comparisonSection" class="comparison-section"></div>
        </div>
    </div>

    <!-- html2canvas for PDF generation -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <script>
        let studentsData = {};
        let currentStudent = null;
        let analysisMode = 'daily';
        let comparisonType = 'day1';
        let chartInstances = {
            progress: null,
            improvement: null,
            heatmap: null,
            improvementTimeline: null,
            comparisonProgress: null,
            comparisonImprovement: null,
            comparisonMastery: null
        };

        function resetForNewStudent() {
            studentsData = {};
            currentStudent = null;
            
            document.getElementById('fileInput').value = '';
            document.getElementById('blankFill1').value = '';
            document.getElementById('blankFill2').value = '';
            document.getElementById('dailyWeekInput').value = '';
            
            document.getElementById('studentTabs').innerHTML = '';
            document.getElementById('reportsContainer').innerHTML = '';
            document.getElementById('comparisonSection').innerHTML = '';
            
            document.querySelector('.empty-state').style.display = 'block';
            
            const fileInputLabel = document.getElementById('fileInputLabel');
            const processBtn = document.getElementById('processBtn');
            const newStudentBtn = document.getElementById('newStudentBtn');
            
            fileInputLabel.classList.remove('disabled');
            processBtn.disabled = false;
            newStudentBtn.disabled = true;
            
            document.getElementById('dailyBtn').disabled = false;
            document.getElementById('consecutiveBtn').disabled = false;
            document.getElementById('comparisonBtn').disabled = false;
            
            document.getElementById('day1Btn').disabled = false;
            document.getElementById('monthBtn').disabled = false;
            document.getElementById('weekBtn').disabled = false;
            
            document.getElementById('blankFill1').disabled = false;
            document.getElementById('blankFill2').disabled = false;
            
            document.getElementById('dailyWeekInput').disabled = false;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function setMode(mode) {
            analysisMode = mode;
            document.getElementById('dailyBtn').classList.toggle('active', mode === 'daily');
            document.getElementById('consecutiveBtn').classList.toggle('active', mode === 'consecutive');
            document.getElementById('comparisonBtn').classList.toggle('active', mode === 'comparison');
            
            const comparisonOptions = document.getElementById('comparisonOptions');
            const dailyWeekSelector = document.getElementById('dailyWeekSelector');
            
            if (mode === 'comparison') {
                comparisonOptions.classList.add('active');
                dailyWeekSelector.style.display = 'none';
            } else if (mode === 'daily') {
                comparisonOptions.classList.remove('active');
                dailyWeekSelector.style.display = 'flex';
            } else {
                comparisonOptions.classList.remove('active');
                dailyWeekSelector.style.display = 'none';
            }
        }

        function setComparisonType(type) {
            comparisonType = type;
            document.getElementById('day1Btn').classList.toggle('active', type === 'day1');
            document.getElementById('monthBtn').classList.toggle('active', type === 'month');
            document.getElementById('weekBtn').classList.toggle('active', type === 'week');
        }

        function getBlankFillValues() {
            const val1 = document.getElementById('blankFill1').value;
            const val2 = document.getElementById('blankFill2').value;
            
            if (!val1 && !val2) {
                return null;
            }
            
            const values = [];
            if (val1) values.push(parseFloat(val1));
            if (val2) values.push(parseFloat(val2));
            
            return values;
        }

        function fillBlankCells(score, blankFillValues) {
            if (score !== null && score !== undefined && score.toString().trim() !== '') {
                return score;
            }
            
            if (!blankFillValues || blankFillValues.length === 0) {
                return null;
            }
            
            if (blankFillValues.length === 1) {
                return blankFillValues[0];
            }
            
            return blankFillValues[Math.floor(Math.random() * blankFillValues.length)];
        }

        function processFiles() {
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;
            
            if (files.length === 0) {
                alert('Please select at least one CSV file');
                return;
            }
            
            if (files.length > 10) {
                alert('Maximum 10 files allowed');
                return;
            }

            document.getElementById('dailyBtn').disabled = true;
            document.getElementById('consecutiveBtn').disabled = true;
            document.getElementById('comparisonBtn').disabled = true;
            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('processBtn').disabled = true;
            
            studentsData = {};
            
            let filesProcessed = 0;
            let successfulFiles = 0;
            
            const blankFillValues = getBlankFillValues();
            
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    Papa.parse(e.target.result, {
                        complete: function(results) {
                            const studentData = parseCSVData(results.data, file.name, blankFillValues);
                            if (studentData) {
                                const processedData = processStudentData(studentData);
                                if (processedData) {
                                    studentsData[studentData.name] = processedData;
                                    successfulFiles++;
                                }
                            }
                            
                            filesProcessed++;
                            if (filesProcessed === files.length) {
                                document.getElementById('loadingMessage').style.display = 'none';
                                document.getElementById('processBtn').disabled = false;
                                
                                if (successfulFiles === 0) {
                                    alert('No valid CSV files could be processed. Please check your file format.');
                                    document.getElementById('dailyBtn').disabled = false;
                                    document.getElementById('consecutiveBtn').disabled = false;
                                    document.getElementById('comparisonBtn').disabled = false;
                                    return;
                                }
                                
                                document.querySelector('.empty-state').style.display = 'none';
                                
                                displayStudentTabs();
                                if (Object.keys(studentsData).length > 0) {
                                    showStudent(Object.keys(studentsData)[0]);
                                    
                                    const fileInputLabel = document.getElementById('fileInputLabel');
                                    const processBtn = document.getElementById('processBtn');
                                    const newStudentBtn = document.getElementById('newStudentBtn');
                                    
                                    fileInputLabel.classList.add('disabled');
                                    processBtn.disabled = true;
                                    newStudentBtn.disabled = false;
                                    
                                    document.getElementById('dailyBtn').disabled = true;
                                    document.getElementById('consecutiveBtn').disabled = true;
                                    document.getElementById('comparisonBtn').disabled = true;
                                    
                                    document.getElementById('day1Btn').disabled = true;
                                    document.getElementById('monthBtn').disabled = true;
                                    document.getElementById('weekBtn').disabled = true;
                                    
                                    document.getElementById('blankFill1').disabled = true;
                                    document.getElementById('blankFill2').disabled = true;
                                    
                                    document.getElementById('dailyWeekInput').disabled = true;
                                }
                            }
                        },
                        error: function(error) {
                            console.error(`Error parsing ${file.name}:`, error);
                            filesProcessed++;
                            if (filesProcessed === files.length) {
                                document.getElementById('loadingMessage').style.display = 'none';
                                document.getElementById('processBtn').disabled = false;
                                document.getElementById('dailyBtn').disabled = false;
                                document.getElementById('consecutiveBtn').disabled = false;
                                document.getElementById('comparisonBtn').disabled = false;
                            }
                        }
                    });
                };
                reader.readAsText(file);
            });
        }

        function parseCSVData(data, filename, blankFillValues) {
            try {
                let studentName = filename.replace('.csv', '').replace('Student_improvement_Metric_-_', '').replace('Student_Improvement_Metric_-_', '').replace('Academy_Sheet_-_', '');
                
                if (!data || data.length < 2) {
                    console.error(`Invalid CSV structure for ${filename}`);
                    return null;
                }
                
                const weeks = [];
                for (let i = 1; i < data[0].length; i++) {
                    if (data[0][i] && data[0][i].trim() !== '') {
                        weeks.push(data[0][i].trim());
                    }
                }
                
                if (weeks.length === 0) {
                    console.error(`No weeks found in ${filename}`);
                    return null;
                }
                
                const characters = [];
                const scores = {};
                let teacherRecommendations = '';
                
                let teacherRecRowIndex = -1;
                for (let i = 1; i < data.length; i++) {
                    if (data[i] && data[i][0] && data[i][0].trim().toLowerCase() === 'teacher recommendations') {
                        teacherRecRowIndex = i;
                        break;
                    }
                }
                
                const endCharacterRow = teacherRecRowIndex > 0 ? teacherRecRowIndex : data.length;
                
                for (let i = 1; i < endCharacterRow; i++) {
                    if (data[i] && data[i][0] && data[i][0].trim() !== '') {
                        const char = data[i][0].trim();
                        
                        if (char.endsWith(':') || char.toLowerCase() === 'vowels' || char.toLowerCase() === 'consonants') {
                            continue;
                        }
                        
                        characters.push(char);
                        scores[char] = [];
                        
                        for (let j = 1; j <= weeks.length; j++) {
                            let scoreValue = data[i][j];
                            
                            if (!scoreValue || scoreValue.toString().trim() === '') {
                                scoreValue = fillBlankCells(null, blankFillValues);
                            }
                            
                            if (scoreValue === null || scoreValue === undefined) {
                                scores[char].push(null);
                                continue;
                            }
                            
                            const numScore = parseFloat(scoreValue);
                            if (!isNaN(numScore) && numScore >= 0 && numScore <= 10) {
                                scores[char].push(numScore);
                            } else {
                                scores[char].push(null);
                            }
                        }
                    }
                }
                
                if (teacherRecRowIndex > 0 && data[teacherRecRowIndex + 1]) {
                    const recRow = data[teacherRecRowIndex + 1];
                    teacherRecommendations = '';
                    for (let j = 0; j < recRow.length; j++) {
                        if (recRow[j] && recRow[j].trim() !== '') {
                            teacherRecommendations = recRow[j].trim();
                            break;
                        }
                    }
                }
                
                if (characters.length === 0) {
                    console.error(`No characters found in ${filename}`);
                    return null;
                }
                
                return {
                    name: studentName,
                    weeks: weeks,
                    characters: characters,
                    scores: scores,
                    teacherRecommendations: teacherRecommendations
                };
            } catch (error) {
                console.error(`Error parsing ${filename}:`, error);
                return null;
            }
        }

        function processStudentData(studentData) {
            const processed = {
                ...studentData,
                weeklyAverages: [],
                characterImprovements: {},
                statistics: {}
            };
            
            for (let i = 0; i < studentData.weeks.length; i++) {
                let weekSum = 0;
                let count = 0;
                for (let char of studentData.characters) {
                    if (studentData.scores[char] && studentData.scores[char][i] !== null && studentData.scores[char][i] !== undefined) {
                        weekSum += studentData.scores[char][i];
                        count++;
                    }
                }
                processed.weeklyAverages.push(count > 0 ? weekSum / count : null);
            }
            
            for (let char of studentData.characters) {
                const scores = studentData.scores[char];
                if (scores && scores.length > 0) {
                    let startScore = null;
                    for (let i = 0; i < scores.length; i++) {
                        if (scores[i] !== null && scores[i] !== undefined) {
                            startScore = scores[i];
                            break;
                        }
                    }
                    
                    let endScore = null;
                    for (let i = scores.length - 1; i >= 0; i--) {
                        if (scores[i] !== null && scores[i] !== undefined) {
                            endScore = scores[i];
                            break;
                        }
                    }
                    
                    const hasData = startScore !== null && endScore !== null;
                    
                    processed.characterImprovements[char] = {
                        start: startScore,
                        end: endScore,
                        improvement: hasData ? endScore - startScore : null,
                        mastered: endScore === 10,
                        scores: scores,
                        hasData: hasData
                    };
                }
            }
            
            const weeksWithData = processed.weeklyAverages.filter(avg => avg !== null && avg !== undefined);
            const startAvg = weeksWithData.length > 0 ? weeksWithData[0] : 0;
            const endAvg = weeksWithData.length > 0 ? weeksWithData[weeksWithData.length - 1] : 0;
            const totalImprovement = endAvg - startAvg;
            
            const charactersWithData = Object.values(processed.characterImprovements).filter(c => c.hasData);
            const masteredCount = charactersWithData.filter(c => c.mastered).length;
            
            const lowestScores = Object.entries(processed.characterImprovements)
                .filter(([char, data]) => data.hasData)
                .map(([char, data]) => ({char, ...data}))
                .sort((a, b) => a.end - b.end)
                .slice(0, 5);
            
            const bestImprovements = Object.entries(processed.characterImprovements)
                .filter(([char, data]) => data.hasData)
                .map(([char, data]) => ({char, ...data}))
                .sort((a, b) => b.improvement - a.improvement)
                .slice(0, 5);
            
            processed.statistics = {
                startAverage: startAvg,
                endAverage: endAvg,
                totalImprovement: totalImprovement,
                masteredCount: masteredCount,
                totalCharacters: charactersWithData.length,
                totalCharactersIncludingNoData: studentData.characters.length,
                masteryRate: charactersWithData.length > 0 ? (masteredCount / charactersWithData.length * 100) : 0,
                lowestScores: lowestScores,
                bestImprovements: bestImprovements
            };
            
            return processed;
        }

        function getScoreColor(score) {
            if (score === 10) return 'gold';
            if (score >= 8) return 'high';
            if (score > 4) return 'medium';
            return 'low';
        }

        function getScoreColorHex(score) {
            if (score === 10) return '#f9d423';
            if (score >= 8) return '#38ef7d';
            if (score > 4) return '#FFC107';
            return '#f45c43';
        }

        function getMasteryHeader(score) {
            if (score === 10) {
                return '<div class="mastery-header mastered">‚≠ê Mastered!</div>';
            } else if (score >= 8) {
                return '<div class="mastery-header so-close">So Close!</div>';
            } else if (score > 4) {
                return '<div class="mastery-header keep-studying">Keep studying!</div>';
            } else {
                return '<div class="mastery-header priority-review">Priority Review</div>';
            }
        }

        function displayStudentTabs() {
            const tabsContainer = document.getElementById('studentTabs');
            tabsContainer.innerHTML = '';
            
            Object.keys(studentsData).forEach((studentName, index) => {
                const tab = document.createElement('button');
                tab.className = 'student-tab';
                tab.textContent = studentName;
                tab.onclick = () => showStudent(studentName);
                tabsContainer.appendChild(tab);
            });
        }

        function showStudent(studentName) {
            currentStudent = studentName;
            const data = studentsData[studentName];
            
            document.querySelectorAll('.student-tab').forEach(tab => {
                tab.classList.toggle('active', tab.textContent === studentName);
            });
            
            document.getElementById('comparisonSection').classList.remove('active');
            
            const reportsContainer = document.getElementById('reportsContainer');
            reportsContainer.innerHTML = generateStudentReport(data);
            
            setTimeout(() => {
                const downloadBtn = document.getElementById(`downloadBtn_${studentName.replace(/\s+/g, '_')}`);
                if (downloadBtn) {
                    downloadBtn.onclick = function() {
                        downloadStudentReportPDF(studentName);
                    };
                }
            }, 10);
            
            requestAnimationFrame(() => {
                setTimeout(() => {
                    if (analysisMode === 'daily') {
                        if (document.getElementById('dailyCharacterChart')) {
                            createDailyCharacterChart(data);
                        }
                    } else if (analysisMode === 'consecutive') {
                        if (document.getElementById('progressChart')) {
                            createProgressChart(data);
                        }
                        if (document.getElementById('improvementChart')) {
                            createImprovementChart(data);
                        }
                    } else if (analysisMode === 'comparison') {
                        if (document.getElementById('comparisonBarChart')) {
                            createComparisonBarChart(data);
                        }
                    }
                }, 50);
            });
        }

        function getDailyWeekIndex(data) {
            const weekInput = document.getElementById('dailyWeekInput').value.trim();
            
            if (!weekInput) {
                return 0;
            }
            
            const lowerInput = weekInput.toLowerCase();
            let weekNumber;
            
            if (lowerInput.startsWith('week ')) {
                weekNumber = parseInt(lowerInput.replace('week ', ''));
            } else {
                weekNumber = parseInt(weekInput);
            }
            
            const weekIndex = weekNumber - 1;
            
            if (isNaN(weekIndex) || weekIndex < 0 || weekIndex >= data.weeks.length) {
                alert(`Invalid week input. Please enter a week between 1 and ${data.weeks.length}.`);
                return 0;
            }
            
            return weekIndex;
        }

        function generateStudentReport(data) {
            const stats = data.statistics;
            
            if (analysisMode === 'daily') {
                return generateDailyReport(data, stats);
            } else if (analysisMode === 'consecutive') {
                return generateConsecutiveReport(data, stats);
            } else {
                return generateComparisonReport(data, stats);
            }
        }

        function generateDailyReport(data, stats) {
            let weekWithDataIndex = getDailyWeekIndex(data);
            let weekWithDataName = data.weeks[weekWithDataIndex];
            
            const weekScores = [];
            data.characters.forEach(char => {
                const score = data.scores[char][weekWithDataIndex];
                if (score !== null && score !== undefined) {
                    weekScores.push(score);
                }
            });
            
            const dailyAverage = weekScores.length > 0 
                ? weekScores.reduce((sum, score) => sum + score, 0) / weekScores.length 
                : 0;
            
            const masteredCount = weekScores.filter(score => score === 10).length;
            const masteryRate = weekScores.length > 0 ? (masteredCount / weekScores.length * 100) : 0;
            
            return `
                <div class="student-report active" data-student="${data.name}">
                    <div class="download-section">
                        <div>
                            <strong style="color: white; font-size: 1.1em;">üìä Export Options</strong>
                            <span style="color: rgba(255,255,255,0.9); margin-left: 10px;">Download report as PDF</span>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="download-btn" id="downloadBtn_${data.name.replace(/\s+/g, '_')}">
                                üì• Download ${data.name}'s PDF Report
                            </button>
                        </div>
                        <div class="download-status" id="downloadStatus">
                            Preparing download...
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px; margin-bottom: 30px; text-align: center;">
                        <h2 style="font-size: 2em; margin-bottom: 10px;">üìÖ Daily Progress Report</h2>
                        <p style="font-size: 1.3em; opacity: 0.9;">${weekWithDataName}</p>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card ${getScoreColor(dailyAverage)}">
                            <div class="label">Daily Average</div>
                            <div class="value">${dailyAverage.toFixed(1)}/10</div>
                            <div class="change">Overall Performance</div>
                            <div class="description">Average score across all characters</div>
                        </div>
                        
                        <div class="stat-card gold">
                            <div class="label">Characters Mastered</div>
                            <div class="value">${masteredCount}/${weekScores.length}</div>
                            <div class="change">${masteryRate.toFixed(1)}% Mastery Rate</div>
                            <div class="description">Characters achieving 10/10</div>
                        </div>
                    </div>
                    
                    <div class="chart-container" style="height: 820px;">
                        <div class="chart-title">
                            <span class="emoji">üìä</span>
                            Character Performance Breakdown
                        </div>
                        <div style="position: relative; height: 740px;">
                            <canvas id="dailyCharacterChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="details-section">
                        <div class="details-title">üìä Detailed Character Analysis</div>
                        <div class="character-grid">
                            ${generateCharacterCards(data)}
                        </div>
                    </div>
                    
                    <div class="details-section">
                        <div class="details-title">üí° Key Insights & Recommendations</div>
                        ${generateInsights(data)}
                        ${generateTeacherRecommendations(data)}
                    </div>
                </div>
            `;
        }

        function generateConsecutiveReport(data, stats) {
            return `
                <div class="student-report active" data-student="${data.name}">
                    <div class="download-section">
                        <div>
                            <strong style="color: white; font-size: 1.1em;">üìä Export Options</strong>
                            <span style="color: rgba(255,255,255,0.9); margin-left: 10px;">Download report as PDF</span>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="download-btn" id="downloadBtn_${data.name.replace(/\s+/g, '_')}">
                                üì• Download ${data.name}'s PDF Report
                            </button>
                        </div>
                        <div class="download-status" id="downloadStatus">
                            Preparing download...
                        </div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card ${getScoreColor(stats.startAverage)}">
                            <div class="label">Starting Average</div>
                            <div class="value">${stats.startAverage.toFixed(1)}/10</div>
                            <div class="change">First Week Baseline</div>
                            <div class="description">Average score on first week</div>
                        </div>
                        
                        <div class="stat-card ${stats.totalImprovement >= 0 ? 'positive' : 'negative'}">
                            <div class="label">Current Average</div>
                            <div class="value">${stats.endAverage.toFixed(1)}/10</div>
                            <div class="change">${stats.totalImprovement >= 0 ? '+' : ''}${stats.totalImprovement.toFixed(1)} Total</div>
                            <div class="description">Average score on latest week</div>
                        </div>
                        
                        <div class="stat-card gold">
                            <div class="label">Characters Mastered</div>
                            <div class="value">${stats.masteredCount}/${stats.totalCharacters}</div>
                            <div class="change">${stats.masteryRate.toFixed(1)}% Mastery Rate</div>
                            <div class="description">Characters achieving 10/10</div>
                        </div>
                        
                        <div class="stat-card ${stats.totalImprovement >= 0 ? 'positive' : 'negative'}">
                            <div class="label">Total Improvement</div>
                            <div class="value">${stats.totalImprovement >= 0 ? '+' : ''}${stats.totalImprovement.toFixed(1)}</div>
                            <div class="change">From First to Last Week</div>
                            <div class="description">Overall progress made</div>
                        </div>
                    </div>
                    
                    <div class="charts-grid">
                        <div class="chart-container">
                            <div class="chart-title">
                                <span class="emoji">üìà</span>
                                Consecutive Progress Overview
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="progressChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-title">
                                <span class="emoji">üéØ</span>
                                Top 5 Character Improvements
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="improvementChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="details-section">
                        <div class="details-title">üìä Detailed Character Analysis</div>
                        <div class="character-grid">
                            ${generateCharacterCards(data)}
                        </div>
                    </div>
                    
                    <div class="details-section">
                        <div class="details-title">üí° Key Insights & Recommendations</div>
                        ${generateInsights(data)}
                        ${generateTeacherRecommendations(data)}
                    </div>
                </div>
            `;
        }

        function generateComparisonReport(data, stats) {
            const currentIndex = data.weeks.length - 1;
            let compareIndex = 0;
            let comparisonTitle = '';
            
            if (comparisonType === 'day1') {
                compareIndex = 0;
                comparisonTitle = `${data.weeks[0]} vs ${data.weeks[currentIndex]}`;
            } else if (comparisonType === 'month') {
                compareIndex = Math.max(0, currentIndex - 4);
                comparisonTitle = `${data.weeks[compareIndex]} vs ${data.weeks[currentIndex]}`;
            } else if (comparisonType === 'week') {
                compareIndex = Math.max(0, currentIndex - 1);
                comparisonTitle = `${data.weeks[compareIndex]} vs ${data.weeks[currentIndex]}`;
            }
            
            const improvements = [];
            data.characters.forEach(char => {
                const scores = data.scores[char];
                const oldScore = scores[compareIndex];
                const newScore = scores[currentIndex];
                
                if (oldScore !== null && newScore !== null) {
                    improvements.push({
                        char: char,
                        old: oldScore,
                        new: newScore,
                        change: newScore - oldScore
                    });
                }
            });
            
            improvements.sort((a, b) => b.change - a.change);
            
            const avgOld = improvements.reduce((sum, item) => sum + item.old, 0) / improvements.length;
            const avgNew = improvements.reduce((sum, item) => sum + item.new, 0) / improvements.length;
            const avgChange = avgNew - avgOld;
            
            return `
                <div class="student-report active" data-student="${data.name}">
                    <div class="download-section">
                        <div>
                            <strong style="color: white; font-size: 1.1em;">üìä Export Options</strong>
                            <span style="color: rgba(255,255,255,0.9); margin-left: 10px;">Download report as PDF</span>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="download-btn" id="downloadBtn_${data.name.replace(/\s+/g, '_')}">
                                üì• Download ${data.name}'s PDF Report
                            </button>
                        </div>
                        <div class="download-status" id="downloadStatus">
                            Preparing download...
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px; margin-bottom: 30px; text-align: center;">
                        <h2 style="font-size: 2em; margin-bottom: 10px;">üìä Comparison Chart</h2>
                        <p style="font-size: 1.3em; opacity: 0.9;">${comparisonTitle}</p>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card ${getScoreColor(avgOld)}">
                            <div class="label">Previous Average</div>
                            <div class="value">${avgOld.toFixed(1)}/10</div>
                            <div class="change">${data.weeks[compareIndex]}</div>
                        </div>
                        
                        <div class="stat-card ${getScoreColor(avgNew)}">
                            <div class="label">Current Average</div>
                            <div class="value">${avgNew.toFixed(1)}/10</div>
                            <div class="change">${data.weeks[currentIndex]}</div>
                        </div>
                        
                        <div class="stat-card ${avgChange >= 0 ? 'positive' : 'negative'}">
                            <div class="label">Change</div>
                            <div class="value">${avgChange >= 0 ? '+' : ''}${avgChange.toFixed(1)}</div>
                            <div class="change">Overall Improvement</div>
                        </div>
                    </div>
                    
                    <div class="chart-container" style="height: 870px;">
                        <div class="chart-title">
                            <span class="emoji">üìä</span>
                            Character Comparison: ${comparisonTitle}
                        </div>
                        <div style="position: relative; height: 790px;">
                            <canvas id="comparisonBarChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="details-section">
                        <div class="details-title">üìä Top Improvements</div>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                    <th style="padding: 12px; text-align: left;">Rank</th>
                                    <th style="padding: 12px; text-align: left;">Character</th>
                                    <th style="padding: 12px; text-align: center;">Previous</th>
                                    <th style="padding: 12px; text-align: center;">Current</th>
                                    <th style="padding: 12px; text-align: center;">Change</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${improvements.slice(0, 10).map((item, index) => `
                                    <tr style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};">
                                        <td style="padding: 12px; font-weight: bold;">${index + 1}</td>
                                        <td style="padding: 12px; font-size: 1.5em;">${item.char}</td>
                                        <td style="padding: 12px; text-align: center;">${item.old.toFixed(1)}/10</td>
                                        <td style="padding: 12px; text-align: center; font-weight: bold; color: ${getScoreColorHex(item.new)};">${item.new.toFixed(1)}/10</td>
                                        <td style="padding: 12px; text-align: center; font-weight: bold; color: ${item.change >= 0 ? '#06BA63' : '#f45c43'};">
                                            ${item.change >= 0 ? '+' : ''}${item.change.toFixed(1)}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="details-section">
                        <div class="details-title">üí° Key Insights & Recommendations</div>
                        ${generateInsights(data)}
                        ${generateTeacherRecommendations(data)}
                    </div>
                </div>
            `;
        }

        function generateCharacterCards(data) {
            const isDaily = analysisMode === 'daily';
            const isComparison = analysisMode === 'comparison';
            
            const dailyWeekIndex = isDaily ? getDailyWeekIndex(data) : 0;
            
            return data.characters.map(char => {
                const improvement = data.characterImprovements[char];
                
                if (isDaily) {
                    const weekScore = data.scores[char][dailyWeekIndex];
                    
                    if (weekScore === null || weekScore === undefined) {
                        return `
                            <div class="character-card" style="background: #e0e0e0; border-color: #999;">
                                <div class="character-name" style="color: #666;">${char}</div>
                                <div class="character-progress" style="color: #999;">
                                    <div>No Data</div>
                                </div>
                            </div>
                        `;
                    }
                    
                    const scoreClass = 'score-' + getScoreColor(weekScore);
                    
                    return `
                        <div class="character-card ${scoreClass}">
                            ${getMasteryHeader(weekScore)}
                            <div class="character-name">${char}</div>
                            <div class="character-progress">
                                <div>Score: ${weekScore.toFixed(1)}/10</div>
                            </div>
                        </div>
                    `;
                }
                
                if (!improvement.hasData) {
                    return `
                        <div class="character-card" style="background: #e0e0e0; border-color: #999;">
                            <div class="character-name" style="color: #666;">${char}</div>
                            <div class="character-progress" style="color: #999;">
                                <div>No Data</div>
                            </div>
                        </div>
                    `;
                }
                
                const finalScore = improvement.end;
                const scoreClass = 'score-' + getScoreColor(finalScore);
                const improvementClass = 'improvement-' + getScoreColor(finalScore);
                
                if (isComparison) {
                    const currentIndex = data.weeks.length - 1;
                    let compareIndex = 0;
                    
                    if (comparisonType === 'day1') {
                        compareIndex = 0;
                    } else if (comparisonType === 'month') {
                        compareIndex = Math.max(0, currentIndex - 4);
                    } else if (comparisonType === 'week') {
                        compareIndex = Math.max(0, currentIndex - 1);
                    }
                    
                    const oldScore = data.scores[char][compareIndex];
                    const newScore = data.scores[char][currentIndex];
                    const change = newScore !== null && oldScore !== null ? newScore - oldScore : null;
                    
                    return `
                        <div class="character-card ${scoreClass}">
                            ${getMasteryHeader(newScore)}
                            <div class="character-name">${char}</div>
                            <div class="character-progress">
                                <div>Was: ${oldScore !== null ? oldScore.toFixed(1) : 'N/A'}/10</div>
                                <div>Now: ${newScore !== null ? newScore.toFixed(1) : 'N/A'}/10</div>
                            </div>
                            ${change !== null ? `
                                <div class="character-improvement ${change >= 0 ? 'improvement-high' : 'improvement-low'}">
                                    ${change >= 0 ? '+' : ''}${change.toFixed(1)}
                                </div>
                            ` : ''}
                        </div>
                    `;
                } else {
                    return `
                        <div class="character-card ${scoreClass}">
                            ${getMasteryHeader(finalScore)}
                            <div class="character-name">${char}</div>
                            <div class="character-progress">
                                <div>Start: ${improvement.start.toFixed(1)}/10</div>
                                <div>Now: ${improvement.end.toFixed(1)}/10</div>
                            </div>
                            <div class="character-improvement ${improvementClass}">
                                ${improvement.improvement >= 0 ? '+' : ''}${improvement.improvement.toFixed(1)}
                            </div>
                        </div>
                    `;
                }
            }).join('');
        }

        function generateTeacherRecommendations(data) {
            const recommendations = data.teacherRecommendations || '';
            const displayText = recommendations ? recommendations : 'None for now - keep it up!';
            
            return `
                <div class="teacher-recommendations">
                    <h4>üë®‚Äçüè´ Teacher Recommendations:</h4>
                    <p>${displayText}</p>
                </div>
            `;
        }

        function generateInsights(data) {
            const stats = data.statistics;
            const insights = [];
            const isDaily = analysisMode === 'daily';
            
            insights.push('<div class="priority-notice" style="margin-bottom: 15px;">üéØ <strong>Remember:</strong> Prioritize RED and YELLOW characters for maximum improvement!</div>');
            
            let currentAverage = stats.endAverage;
            if (isDaily) {
                const weekIndex = getDailyWeekIndex(data);
                const weekScores = [];
                data.characters.forEach(char => {
                    const score = data.scores[char][weekIndex];
                    if (score !== null && score !== undefined) {
                        weekScores.push(score);
                    }
                });
                currentAverage = weekScores.length > 0 
                    ? weekScores.reduce((sum, score) => sum + score, 0) / weekScores.length 
                    : 0;
            }
            
            if (currentAverage >= 8) {
                insights.push('üåü <strong>Excellent Performance!</strong> Current average is 8.0/10 or higher.');
            } else if (currentAverage >= 6) {
                insights.push('‚úÖ <strong>Good Performance!</strong> Solid progress showing.');
            } else {
                insights.push('üìö <strong>Room for Improvement.</strong> Focus on practice for better results.');
            }
            
            if (stats.masteryRate === 100) {
                insights.push('üéâ <strong>Perfect Mastery!</strong> All characters scored 10/10.');
            } else if (stats.masteryRate >= 80) {
                insights.push(`üéØ <strong>High Mastery Rate!</strong> ${stats.masteredCount} out of ${stats.totalCharacters} characters mastered.`);
            }
            
            insights.push('<br><strong style="font-size: 1.1em;">‚ö†Ô∏è Priority Focus Areas (scores below 60%):</strong>');
            
            let allScoresData = [];
            if (isDaily) {
                const weekIndex = getDailyWeekIndex(data);
                allScoresData = data.characters
                    .map(char => ({
                        char: char,
                        end: data.scores[char][weekIndex]
                    }))
                    .filter(item => item.end !== null && item.end !== undefined)
                    .sort((a, b) => a.end - b.end);
            } else {
                allScoresData = Object.entries(data.characterImprovements)
                    .filter(([char, data]) => data.hasData)
                    .map(([char, data]) => ({char, ...data}))
                    .sort((a, b) => a.end - b.end);
            }
            
            const priorityCharacters = allScoresData.filter(item => item.end < 6);
            
            if (priorityCharacters.length > 0) {
                const redCharacters = priorityCharacters.filter(item => item.end <= 4);
                const yellowCharacters = priorityCharacters.filter(item => item.end > 4 && item.end < 6);
                
                if (redCharacters.length > 0) {
                    insights.push(`<strong style="color: #f45c43;">üî¥ RED ZONE (0.0-4.0) - ${redCharacters.length} characters need URGENT attention:</strong>`);
                    redCharacters.forEach((item, index) => {
                        const videoLink = getVideoLinkHTML(item.char, item.end);
                        insights.push(`${index + 1}. <strong>${item.char}</strong> - ${item.end.toFixed(1)}/10 ${videoLink}`);
                    });
                } else {
                    insights.push(`<strong style="color: #f45c43;">üî¥ RED ZONE (0.0-4.0):</strong> None for now! Keep it up!`);
                }
                
                if (yellowCharacters.length > 0) {
                    insights.push(`<strong style="color: #FFC107;">üü° YELLOW ZONE (4.1-5.9) - ${yellowCharacters.length} characters need focused practice:</strong>`);
                    yellowCharacters.forEach((item, index) => {
                        const videoLink = getVideoLinkHTML(item.char, item.end);
                        insights.push(`${index + 1}. <strong>${item.char}</strong> - ${item.end.toFixed(1)}/10 ${videoLink}`);
                    });
                } else {
                    insights.push(`<strong style="color: #FFC107;">üü° YELLOW ZONE (4.1-5.9):</strong> None for now! Keep it up!`);
                }
            } else {
                insights.push(`<strong style="color: #f45c43;">üî¥ RED ZONE (0.0-4.0):</strong> None for now! Keep it up!`);
                insights.push(`<strong style="color: #FFC107;">üü° YELLOW ZONE (4.1-5.9):</strong> None for now! Keep it up!`);
            }
            
            const reviewCharacters = allScoresData.filter(item => item.end >= 6 && item.end < 10);
            
            if (reviewCharacters.length > 0) {
                insights.push('<br><strong style="font-size: 1.1em;">üìö Regular Review (60-99%, maintain progress):</strong>');
                
                const greenChars = reviewCharacters.filter(item => item.end >= 8);
                if (greenChars.length > 0) {
                    insights.push(`<strong style="color: #38ef7d;">üü¢ GREEN ZONE (8.0-9.9) - ${greenChars.length} characters performing well:</strong>`);
                    greenChars.forEach((item, index) => {
                        const videoLink = getVideoLinkHTML(item.char, item.end);
                        insights.push(`${index + 1}. <strong>${item.char}</strong> - ${item.end.toFixed(1)}/10 ${videoLink}`);
                    });
                } else {
                    insights.push(`<strong style="color: #38ef7d;">üü¢ GREEN ZONE (8.0-9.9):</strong> None for now! Keep it up!`);
                }
                
                const lightYellowChars = reviewCharacters.filter(item => item.end >= 6 && item.end < 8);
                if (lightYellowChars.length > 0) {
                    insights.push(`<strong style="color: #FFC107;">üü° LIGHT YELLOW ZONE (6.0-7.9) - ${lightYellowChars.length} characters close to mastery:</strong>`);
                    lightYellowChars.forEach((item, index) => {
                        const videoLink = getVideoLinkHTML(item.char, item.end);
                        insights.push(`${index + 1}. <strong>${item.char}</strong> - ${item.end.toFixed(1)}/10 ${videoLink}`);
                    });
                } else {
                    insights.push(`<strong style="color: #FFC107;">üü° LIGHT YELLOW ZONE (6.0-7.9):</strong> None for now! Keep it up!`);
                }
            } else {
                insights.push('<br><strong style="font-size: 1.1em;">üìö Regular Review (60-99%, maintain progress):</strong>');
                insights.push(`<strong style="color: #38ef7d;">üü¢ GREEN ZONE (8.0-9.9):</strong> None for now! Keep it up!`);
                insights.push(`<strong style="color: #FFC107;">üü° LIGHT YELLOW ZONE (6.0-7.9):</strong> None for now! Keep it up!`);
            }
            
            const masteredCharacters = allScoresData.filter(item => item.end === 10);
            if (masteredCharacters.length > 0) {
                insights.push('<br><strong>ü•á Mastered Characters (100%, perfect score):</strong>');
                insights.push(`${masteredCharacters.length} character(s) achieved mastery: ${masteredCharacters.map(item => item.char).join(', ')}`);
            }
            
            return `<div style="line-height: 1.8;">${insights.join('<br>')}</div>`;
        }

        function createDailyCharacterChart(data) {
            const canvas = document.getElementById('dailyCharacterChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            const weekIndex = getDailyWeekIndex(data);
            
            const characterScores = data.characters
                .map(char => ({
                    char: char,
                    score: data.scores[char][weekIndex]
                }))
                .filter(item => item.score !== null && item.score !== undefined)
                .sort((a, b) => b.score - a.score);
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: characterScores.map(item => item.char),
                    datasets: [{
                        label: 'Score (out of 10)',
                        data: characterScores.map(item => item.score),
                        backgroundColor: characterScores.map(item => getScoreColorHex(item.score)),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            bottom: 40,
                            left: 10,
                            right: 10,
                            top: 10
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                font: {
                                    size: 18
                                },
                                maxRotation: 0,
                                minRotation: 0,
                                padding: 10
                            }
                        },
                        y: {
                            beginAtZero: true,
                            max: 10,
                            ticks: {
                                callback: function(value) {
                                    return value + '/10';
                                }
                            }
                        }
                    },
                    plugins: { 
                        legend: { display: false }
                    }
                }
            });
        }

        function createProgressChart(data) {
            const canvas = document.getElementById('progressChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            if (chartInstances.progress) {
                chartInstances.progress.destroy();
            }
            
            const weeksWithData = [];
            const averagesWithData = [];
            
            data.weeks.forEach((week, index) => {
                if (data.weeklyAverages[index] !== null && data.weeklyAverages[index] !== undefined) {
                    weeksWithData.push(week);
                    averagesWithData.push(data.weeklyAverages[index]);
                }
            });
            
            chartInstances.progress = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: weeksWithData,
                    datasets: [{
                        label: 'Average Score',
                        data: averagesWithData,
                        borderColor: 'rgb(102, 126, 234)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 6,
                        pointBackgroundColor: 'white',
                        pointBorderColor: 'rgb(102, 126, 234)',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10,
                            ticks: {
                                callback: function(value) {
                                    return value + '/10';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function createImprovementChart(data) {
            const canvas = document.getElementById('improvementChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            if (chartInstances.improvement) {
                chartInstances.improvement.destroy();
            }
            
            const topImprovements = Object.entries(data.characterImprovements)
                .filter(([char, data]) => data.hasData)
                .sort((a, b) => b[1].improvement - a[1].improvement)
                .slice(0, 5);
            
            chartInstances.improvement = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topImprovements.map(([char, _]) => char),
                    datasets: [{
                        label: 'Improvement',
                        data: topImprovements.map(([_, data]) => data.improvement),
                        backgroundColor: topImprovements.map(([_, data]) => 
                            data.improvement >= 0 ? 'rgba(56, 239, 125, 0.8)' : 'rgba(244, 92, 67, 0.8)'
                        ),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return (value >= 0 ? '+' : '') + value;
                                }
                            }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function createComparisonBarChart(data) {
            const canvas = document.getElementById('comparisonBarChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            if (chartInstances.comparison) {
                chartInstances.comparison.destroy();
            }
            
            const currentIndex = data.weeks.length - 1;
            let compareIndex = 0;
            
            if (comparisonType === 'day1') {
                compareIndex = 0;
            } else if (comparisonType === 'month') {
                compareIndex = Math.max(0, currentIndex - 4);
            } else if (comparisonType === 'week') {
                compareIndex = Math.max(0, currentIndex - 1);
            }
            
            const improvements = [];
            data.characters.forEach(char => {
                const scores = data.scores[char];
                const oldScore = scores[compareIndex];
                const newScore = scores[currentIndex];
                
                if (oldScore !== null && newScore !== null) {
                    improvements.push({
                        char: char,
                        old: oldScore,
                        new: newScore,
                        change: newScore - oldScore
                    });
                }
            });
            
            improvements.sort((a, b) => b.change - a.change);
            
            chartInstances.comparison = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: improvements.map(item => item.char),
                    datasets: [
                        {
                            label: data.weeks[compareIndex],
                            data: improvements.map(item => item.old),
                            backgroundColor: 'rgba(102, 126, 234, 0.7)',
                            borderWidth: 2
                        },
                        {
                            label: data.weeks[currentIndex],
                            data: improvements.map(item => item.new),
                            backgroundColor: improvements.map(item => getScoreColorHex(item.new) + 'B3'),
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            bottom: 40,
                            left: 10,
                            right: 10,
                            top: 10
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                font: {
                                    size: 18
                                },
                                maxRotation: 0,
                                minRotation: 0,
                                padding: 10
                            }
                        },
                        y: {
                            beginAtZero: true,
                            max: 10,
                            ticks: {
                                callback: function(value) {
                                    return value + '/10';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }

        const videoLinksMap = {
            '„Ñ±': 'https://www.loom.com/share/bde1c41374f24cc5ba516cf659df0d36',
            '„Ñ¥': 'https://www.loom.com/share/33c75894ed6d4a0b98310daaa7788d51',
            '„Ñ∑': 'https://www.loom.com/share/7ac4ca22c51f48b18fc8a8b81f12a817',
            '„Ñπ': 'https://www.loom.com/share/e439b6cbab804143aaf45e9bd3d7cddb',
            '„ÖÅ': 'https://www.loom.com/share/bf74c4a6acb14115930559065bf25588',
            '„ÖÇ': 'https://www.loom.com/share/62c7666380e940cfac0e2b1b684a94b6',
            '„ÖÖ': 'https://www.loom.com/share/26d88f842c6c4278a50e2537edcc882f',
            '„Öá': 'https://www.loom.com/share/6655678667ee4687a1502fb1718f9e1e',
            '„Öà': 'https://www.loom.com/share/bf22033d2f72468f95fef634c68d6650',
            '„Öâ': 'https://www.loom.com/share/276e388e36c64baa98cda921cc04d144',
            '„Ñ≤': 'https://www.loom.com/share/d4788f8fcd8d41bcaff58916217449af',
            '„Ñ∏': 'https://www.loom.com/share/6b5a389e842a4fa8ad0d396a77215b20',
            '„ÖÉ': 'https://www.loom.com/share/fe36ef55e4674c9d9efd0f450ff0a8d5',
            '„Öè': 'https://www.loom.com/share/d5fc79b3c094401ab76ccf5b379776a5',
            '„Öê': 'https://www.loom.com/share/579d0ab338bc42f3af75285f560f394d',
            '„Öí': 'https://www.loom.com/share/579d0ab338bc42f3af75285f560f394d',
            '„Öì': 'https://www.loom.com/share/d5fc79b3c094401ab76ccf5b379776a5',
            '„Öî': 'https://www.loom.com/share/579d0ab338bc42f3af75285f560f394d',
            '„Öñ': 'https://www.loom.com/share/579d0ab338bc42f3af75285f560f394d',
            '„Öó': 'https://www.loom.com/share/30ad74da3807499ba2ccd02053edd046',
            '„Öò': 'https://www.loom.com/share/506c1f2dcc7440c383127c1fbc69b48a',
            '„Öô': 'https://www.loom.com/share/df65d668742741a7900b45bc091cac7c',
            '„Öö': 'https://www.loom.com/share/506c1f2dcc7440c383127c1fbc69b48a',
            '„Öú': 'https://www.loom.com/share/30ad74da3807499ba2ccd02053edd046',
            '„Öù': 'https://www.loom.com/share/b9dfa8e9c76c4537a603aa6e2a909342',
            '„Öû': 'https://www.loom.com/share/df65d668742741a7900b45bc091cac7c',
            '„Öü': 'https://www.loom.com/share/df65d668742741a7900b45bc091cac7c',
            '„Ö°': 'https://www.loom.com/share/7a09ee7a1d9147b08d48c867e434897c',
            'Ïùò': 'https://www.loom.com/share/f3cf5a1872b64befb8959f9146648745',
            '„Ö£': 'https://www.loom.com/share/23bf0e1e1be142f89d92cc827032c0a5'
        };

        function getVideoLinkHTML(char, score) {
            if (score >= 10) {
                return '';
            }
            
            const link = videoLinksMap[char];
            if (link) {
                return `<a href="${link}" target="_blank" class="video-link" data-video-url="${link}" data-char="${char}" style="color: #667eea; text-decoration: none; font-weight: 600; margin-left: 10px; display: inline-block; padding: 5px 10px; background: rgba(102, 126, 234, 0.1); border-radius: 5px; border: 1px solid #667eea;">üé• Watch Video</a>`;
            }
            return '';
        }

        async function downloadStudentReportPDF(studentName) {
            const statusEl = document.getElementById('downloadStatus');
            const downloadBtn = document.getElementById(`downloadBtn_${studentName.replace(/\s+/g, '_')}`);
            
            if (statusEl) {
                statusEl.style.display = 'block';
                statusEl.textContent = `Waiting...`;
            }
            
            if (downloadBtn) {
                downloadBtn.style.display = 'none';
            }

            try {
                if (document.fonts && document.fonts.ready) {
                    await document.fonts.ready;
                }
                
                const { jsPDF } = window.jspdf;
                const data = studentsData[studentName];

                const reportEl = document.querySelector(`.student-report.active`);
                if (!reportEl) {
                    alert('No report found to export.');
                    if (statusEl) statusEl.style.display = 'none';
                    if (downloadBtn) downloadBtn.style.display = 'flex';
                    return;
                }

                const pdfContainer = document.createElement('div');
                pdfContainer.style.width = '1200px';
                pdfContainer.style.background = 'white';
                pdfContainer.style.padding = '40px';
                pdfContainer.style.position = 'absolute';
                pdfContainer.style.left = '-9999px';
                pdfContainer.style.fontFamily = "'Noto Sans KR', sans-serif";
                
                // Build PDF content based on mode
                let pdfContent = `
                    <div style="text-align: center; margin-bottom: 30px; padding: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px;">
                        <img src="https://cdn.shopify.com/s/files/1/0674/6747/7282/files/logo555.png?v=1757969221" alt="Korean Learning Logo" style="max-width: 200px; height: auto; margin-bottom: 20px;">
                        <h1 style="font-size: 2.5em; margin-bottom: 10px; font-weight: 600;">üìö KoreanLearnin Progress Report</h1>
                        <h2 style="font-size: 2em; margin-top: 15px; font-weight: 400;">${studentName}</h2>
                        <p style="font-size: 1.2em; margin-top: 10px; opacity: 0.9;">Graded out of 10</p>
                    </div>
                    
                    <div style="display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; flex-wrap: wrap;">
                        <img src="https://cdn.shopify.com/s/files/1/0674/6747/7282/files/4b45bdfbd4b83c4f97f7c58cd8e49623_31e72055-468c-4c6f-82a0-f79734707937.png?v=1731621340" style="width: 50px; height: 50px;">
                        <img src="https://cdn.shopify.com/s/files/1/0674/6747/7282/files/9025db2a75c6ad48c96d559511317306.png?v=1731621340" style="width: 50px; height: 50px;">
                        <img src="https://cdn.shopify.com/s/files/1/0674/6747/7282/files/f27348ba976bcb866a09d5e281c36e55.png?v=1731621339" style="width: 50px; height: 50px;">
                        <img src="https://cdn.shopify.com/s/files/1/0674/6747/7282/files/96af0d4d3db9c09d03897cd19f41ec8c.png?v=1731621340" style="width: 50px; height: 50px;">
                        <img src="https://cdn.shopify.com/s/files/1/0674/6747/7282/files/ba361cb80f08dfce6c255ebc1dc8b0aa.png?v=1731621340" style="width: 50px; height: 50px;">
                        <img src="https://cdn.shopify.com/s/files/1/0674/6747/7282/files/71dc38903bd85b1734e6c742fb694eec.png?v=1731621340" style="width: 50px; height: 50px;">
                    </div>
                `;

                const stats = data.statistics;

                if (analysisMode === 'daily') {
                    const weekIndex = getDailyWeekIndex(data);
                    const weekName = data.weeks[weekIndex];
                    const weekScores = [];
                    data.characters.forEach(char => {
                        const score = data.scores[char][weekIndex];
                        if (score !== null && score !== undefined) {
                            weekScores.push(score);
                        }
                    });
                    const dailyAverage = weekScores.length > 0 
                        ? weekScores.reduce((sum, score) => sum + score, 0) / weekScores.length 
                        : 0;
                    const masteredCount = weekScores.filter(score => score === 10).length;
                    const masteryRate = weekScores.length > 0 ? (masteredCount / weekScores.length * 100) : 0;

                    pdfContent += `
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px; margin-bottom: 30px; text-align: center;">
                            <h2 style="font-size: 2em; margin-bottom: 10px;">üìÖ Daily Progress Report</h2>
                            <p style="font-size: 1.3em; opacity: 0.9;">${weekName}</p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px;">
                            <div style="background: linear-gradient(135deg, ${getScoreColorHex(dailyAverage)} 0%, ${getScoreColorHex(dailyAverage)} 100%); color: white; padding: 25px; border-radius: 15px; text-align: center;">
                                <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px;">Daily Average</div>
                                <div style="font-size: 2.5em; font-weight: 300; margin-bottom: 5px;">${dailyAverage.toFixed(1)}/10</div>
                                <div style="font-size: 1.1em; opacity: 0.9;">Overall Performance</div>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #f9d423 0%, #ff4e50 100%); color: white; padding: 25px; border-radius: 15px; text-align: center;">
                                <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px;">Characters Mastered</div>
                                <div style="font-size: 2.5em; font-weight: 300; margin-bottom: 5px;">${masteredCount}/${weekScores.length}</div>
                                <div style="font-size: 1.1em; opacity: 0.9;">${masteryRate.toFixed(1)}% Mastery Rate</div>
                            </div>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, rgba(235, 51, 73, 0.1) 0%, rgba(244, 92, 67, 0.1) 100%); padding: 20px; border-radius: 10px; margin-bottom: 30px; border-left: 4px solid #f45c43; font-weight: 600; color: #f45c43; font-size: 1.1em; text-align: center;">
                            ‚ö†Ô∏è PRIORITY: Focus on RED and YELLOW characters for maximum improvement!
                        </div>
                    `;
                    
                    // Add Daily Character Performance Chart
                    const dailyChart = document.getElementById('dailyCharacterChart');
                    if (dailyChart) {
                        const dailyImage = dailyChart.toDataURL('image/png', 1.0);
                        pdfContent += `
                            <div style="background: white; padding: 30px; border-radius: 15px; margin-bottom: 30px;">
                                <h3 style="font-size: 1.3em; color: #333; margin-bottom: 20px;">üìä Character Performance Breakdown</h3>
                                <img src="${dailyImage}" style="width: 100%; height: auto;" />
                            </div>
                        `;
                    }
                } else if (analysisMode === 'consecutive') {
                    pdfContent += `
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px;">
                            <div style="background: linear-gradient(135deg, ${getScoreColorHex(stats.startAverage)} 0%, ${getScoreColorHex(stats.startAverage)} 100%); color: white; padding: 25px; border-radius: 15px; text-align: center;">
                                <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px;">Starting Average</div>
                                <div style="font-size: 2.5em; font-weight: 300; margin-bottom: 5px;">${stats.startAverage.toFixed(1)}/10</div>
                                <div style="font-size: 1.1em; opacity: 0.9;">First Week Baseline</div>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, ${stats.totalImprovement >= 0 ? '#11998e' : '#eb3349'} 0%, ${stats.totalImprovement >= 0 ? '#38ef7d' : '#f45c43'} 100%); color: white; padding: 25px; border-radius: 15px; text-align: center;">
                                <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px;">Current Average</div>
                                <div style="font-size: 2.5em; font-weight: 300; margin-bottom: 5px;">${stats.endAverage.toFixed(1)}/10</div>
                                <div style="font-size: 1.1em; opacity: 0.9;">${stats.totalImprovement >= 0 ? '+' : ''}${stats.totalImprovement.toFixed(1)} Total</div>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #f9d423 0%, #ff4e50 100%); color: white; padding: 25px; border-radius: 15px; text-align: center;">
                                <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px;">Characters Mastered</div>
                                <div style="font-size: 2.5em; font-weight: 300; margin-bottom: 5px;">${stats.masteredCount}/${stats.totalCharacters}</div>
                                <div style="font-size: 1.1em; opacity: 0.9;">${stats.masteryRate.toFixed(1)}% Mastery Rate</div>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, ${stats.totalImprovement >= 0 ? '#11998e' : '#eb3349'} 0%, ${stats.totalImprovement >= 0 ? '#38ef7d' : '#f45c43'} 100%); color: white; padding: 25px; border-radius: 15px; text-align: center;">
                                <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px;">Total Improvement</div>
                                <div style="font-size: 2.5em; font-weight: 300; margin-bottom: 5px;">${stats.totalImprovement >= 0 ? '+' : ''}${stats.totalImprovement.toFixed(1)}</div>
                                <div style="font-size: 1.1em; opacity: 0.9;">From First to Last Week</div>
                            </div>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, rgba(235, 51, 73, 0.1) 0%, rgba(244, 92, 67, 0.1) 100%); padding: 20px; border-radius: 10px; margin-bottom: 30px; border-left: 4px solid #f45c43; font-weight: 600; color: #f45c43; font-size: 1.1em; text-align: center;">
                            ‚ö†Ô∏è PRIORITY: Focus on RED and YELLOW characters for maximum improvement!
                        </div>
                    `;
                    
                    // Add Progress Chart
                    const progressChart = document.getElementById('progressChart');
                    if (progressChart) {
                        const progressImage = progressChart.toDataURL('image/png', 1.0);
                        pdfContent += `
                            <div style="background: white; padding: 30px; border-radius: 15px; margin-bottom: 30px;">
                                <h3 style="font-size: 1.3em; color: #333; margin-bottom: 20px;">üìà Consecutive Progress Overview</h3>
                                <img src="${progressImage}" style="width: 100%; height: auto;" />
                            </div>
                        `;
                    }
                    
                    // Add Improvement Chart
                    const improvementChart = document.getElementById('improvementChart');
                    if (improvementChart) {
                        const improvementImage = improvementChart.toDataURL('image/png', 1.0);
                        pdfContent += `
                            <div style="background: white; padding: 30px; border-radius: 15px; margin-bottom: 30px;">
                                <h3 style="font-size: 1.3em; color: #333; margin-bottom: 20px;">üéØ Top 5 Character Improvements</h3>
                                <img src="${improvementImage}" style="width: 100%; height: auto;" />
                            </div>
                        `;
                    }
                } else if (analysisMode === 'comparison') {
                    const currentIndex = data.weeks.length - 1;
                    let compareIndex = 0;
                    let comparisonTitle = '';
                    
                    if (comparisonType === 'day1') {
                        compareIndex = 0;
                        comparisonTitle = `${data.weeks[0]} vs ${data.weeks[currentIndex]}`;
                    } else if (comparisonType === 'month') {
                        compareIndex = Math.max(0, currentIndex - 4);
                        comparisonTitle = `${data.weeks[compareIndex]} vs ${data.weeks[currentIndex]}`;
                    } else if (comparisonType === 'week') {
                        compareIndex = Math.max(0, currentIndex - 1);
                        comparisonTitle = `${data.weeks[compareIndex]} vs ${data.weeks[currentIndex]}`;
                    }
                    
                    const improvements = [];
                    data.characters.forEach(char => {
                        const scores = data.scores[char];
                        const oldScore = scores[compareIndex];
                        const newScore = scores[currentIndex];
                        
                        if (oldScore !== null && newScore !== null) {
                            improvements.push({
                                char: char,
                                old: oldScore,
                                new: newScore,
                                change: newScore - oldScore
                            });
                        }
                    });
                    
                    const avgOld = improvements.reduce((sum, item) => sum + item.old, 0) / improvements.length;
                    const avgNew = improvements.reduce((sum, item) => sum + item.new, 0) / improvements.length;
                    const avgChange = avgNew - avgOld;

                    pdfContent += `
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px; margin-bottom: 30px; text-align: center;">
                            <h2 style="font-size: 2em; margin-bottom: 10px;">üìä Comparison Chart</h2>
                            <p style="font-size: 1.3em; opacity: 0.9;">${comparisonTitle}</p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
                            <div style="background: linear-gradient(135deg, ${getScoreColorHex(avgOld)} 0%, ${getScoreColorHex(avgOld)} 100%); color: white; padding: 25px; border-radius: 15px; text-align: center;">
                                <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px;">Previous Average</div>
                                <div style="font-size: 2.5em; font-weight: 300; margin-bottom: 5px;">${avgOld.toFixed(1)}/10</div>
                                <div style="font-size: 1.1em; opacity: 0.9;">${data.weeks[compareIndex]}</div>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, ${getScoreColorHex(avgNew)} 0%, ${getScoreColorHex(avgNew)} 100%); color: white; padding: 25px; border-radius: 15px; text-align: center;">
                                <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px;">Current Average</div>
                                <div style="font-size: 2.5em; font-weight: 300; margin-bottom: 5px;">${avgNew.toFixed(1)}/10</div>
                                <div style="font-size: 1.1em; opacity: 0.9;">${data.weeks[currentIndex]}</div>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, ${avgChange >= 0 ? '#11998e' : '#eb3349'} 0%, ${avgChange >= 0 ? '#38ef7d' : '#f45c43'} 100%); color: white; padding: 25px; border-radius: 15px; text-align: center;">
                                <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px;">Change</div>
                                <div style="font-size: 2.5em; font-weight: 300; margin-bottom: 5px;">${avgChange >= 0 ? '+' : ''}${avgChange.toFixed(1)}</div>
                                <div style="font-size: 1.1em; opacity: 0.9;">Overall Improvement</div>
                            </div>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, rgba(235, 51, 73, 0.1) 0%, rgba(244, 92, 67, 0.1) 100%); padding: 20px; border-radius: 10px; margin-bottom: 30px; border-left: 4px solid #f45c43; font-weight: 600; color: #f45c43; font-size: 1.1em; text-align: center;">
                            ‚ö†Ô∏è PRIORITY: Focus on RED and YELLOW characters for maximum improvement!
                        </div>
                    `;
                }

                // For comparison mode, capture the chart and add Top Improvements table
                if (analysisMode === 'comparison') {
                    const comparisonChart = document.getElementById('comparisonBarChart');
                    if (comparisonChart) {
                        const chartImage = comparisonChart.toDataURL('image/png', 1.0);
                        pdfContent += `
                            <div style="background: white; padding: 30px; border-radius: 15px; margin-bottom: 30px;">
                                <h3 style="font-size: 1.3em; color: #333; margin-bottom: 20px;">üìä Character Comparison Chart</h3>
                                <img src="${chartImage}" style="width: 100%; height: auto;" />
                            </div>
                        `;
                    }
                    
                    // Add Top Improvements table for comparison mode
                    const currentIndex = data.weeks.length - 1;
                    let compareIndex = 0;
                    
                    if (comparisonType === 'day1') {
                        compareIndex = 0;
                    } else if (comparisonType === 'month') {
                        compareIndex = Math.max(0, currentIndex - 4);
                    } else if (comparisonType === 'week') {
                        compareIndex = Math.max(0, currentIndex - 1);
                    }
                    
                    const improvements = [];
                    data.characters.forEach(char => {
                        const scores = data.scores[char];
                        const oldScore = scores[compareIndex];
                        const newScore = scores[currentIndex];
                        
                        if (oldScore !== null && newScore !== null) {
                            improvements.push({
                                char: char,
                                old: oldScore,
                                new: newScore,
                                change: newScore - oldScore
                            });
                        }
                    });
                    
                    improvements.sort((a, b) => b.change - a.change);
                    
                    pdfContent += `
                        <div style="background: #f8f9fa; padding: 30px; border-radius: 15px; margin-bottom: 30px;">
                            <h3 style="font-size: 1.3em; color: #333; margin-bottom: 20px;">üìä Top Improvements</h3>
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                        <th style="padding: 12px; text-align: left;">Rank</th>
                                        <th style="padding: 12px; text-align: left;">Character</th>
                                        <th style="padding: 12px; text-align: center;">Previous</th>
                                        <th style="padding: 12px; text-align: center;">Current</th>
                                        <th style="padding: 12px; text-align: center;">Change</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${improvements.slice(0, 10).map((item, index) => `
                                        <tr style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};">
                                            <td style="padding: 12px; font-weight: bold;">${index + 1}</td>
                                            <td style="padding: 12px; font-size: 1.5em;">${item.char}</td>
                                            <td style="padding: 12px; text-align: center;">${item.old.toFixed(1)}/10</td>
                                            <td style="padding: 12px; text-align: center; font-weight: bold; color: ${getScoreColorHex(item.new)};">${item.new.toFixed(1)}/10</td>
                                            <td style="padding: 12px; text-align: center; font-weight: bold; color: ${item.change >= 0 ? '#06BA63' : '#f45c43'};">
                                                ${item.change >= 0 ? '+' : ''}${item.change.toFixed(1)}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    // Add character cards for other modes
                    pdfContent += `
                        <div style="background: #f8f9fa; padding: 30px; border-radius: 15px; margin-bottom: 30px; margin-top: 100px;">
                            <h3 style="font-size: 1.3em; color: #333; margin-bottom: 20px;">üìä Detailed Character Analysis</h3>
                            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px;">
                                ${generateCharacterCardsForPDF(data)}
                            </div>
                        </div>
                    `;
                }

                // Add teacher recommendations
                const recommendations = data.teacherRecommendations || '';
                const displayText = recommendations ? recommendations : 'None for now - keep it up!';
                pdfContent += `
                    <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); padding: 20px; border-radius: 10px; border-left: 4px solid #667eea;">
                        <h4 style="color: #667eea; margin-bottom: 10px; font-size: 1.1em;">üë®‚Äçüè´ Teacher Recommendations:</h4>
                        <p style="color: #333; line-height: 1.8; font-size: 1em;">${displayText}</p>
                    </div>
                `;

                pdfContainer.innerHTML = pdfContent;
                
                document.body.appendChild(pdfContainer);
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const charactersNeedingVideos = [];
                data.characters.forEach(char => {
                    const improvement = data.characterImprovements[char];
                    if (improvement && improvement.end < 10) {
                        const videoUrl = videoLinksMap[char];
                        if (videoUrl) {
                            charactersNeedingVideos.push({
                                char: char,
                                url: videoUrl,
                                score: improvement.end
                            });
                        }
                    }
                });

                if (statusEl) {
                    statusEl.textContent = `Waiting...`;
                }

                const scale = 3;
                const canvas = await html2canvas(pdfContainer, {
                    scale: scale,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    logging: false,
                    windowWidth: 1200
                });

                document.body.removeChild(pdfContainer);

                if (statusEl) {
                    statusEl.textContent = `Waiting...`;
                }

                const imgData = canvas.toDataURL('image/png', 1.0);
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pageWidth = 210;
                const pageHeight = 297;
                const margin = 10;
                const contentWidth = pageWidth - (2 * margin);

                const pxPerMM = canvas.width / pageWidth;
                const imgHeightMM = canvas.height / pxPerMM;

                let y = 0;
                let remaining = imgHeightMM;
                let pageNum = 0;

                while (remaining > 0) {
                    const pageCanvas = document.createElement('canvas');
                    pageCanvas.width = canvas.width;
                    const availableHeight = pageHeight - (2 * margin);
                    const pageHeightPx = Math.min(remaining * pxPerMM, availableHeight * pxPerMM);
                    pageCanvas.height = pageHeightPx;
                    const pageCtx = pageCanvas.getContext('2d');

                    pageCtx.imageSmoothingEnabled = true;
                    pageCtx.imageSmoothingQuality = 'high';

                    pageCtx.drawImage(
                        canvas,
                        0, y * pxPerMM,
                        canvas.width, pageHeightPx,
                        0, 0,
                        canvas.width, pageHeightPx
                    );

                    const pageImg = pageCanvas.toDataURL('image/png', 1.0);
                    
                    if (pageNum > 0) {
                        pdf.addPage();
                    }
                    
                    const imgHeight = Math.min(availableHeight, remaining);
                    pdf.addImage(pageImg, 'PNG', margin, margin, contentWidth, imgHeight);

                    y += availableHeight;
                    remaining -= availableHeight;
                    pageNum++;
                }

                // Add video resources page
                if (charactersNeedingVideos.length > 0) {
                    if (statusEl) {
                        statusEl.textContent = `Waiting...`;
                    }
                    
                    charactersNeedingVideos.sort((a, b) => a.score - b.score);
                    
                    const videoPageContainer = document.createElement('div');
                    videoPageContainer.style.width = '1200px';
                    videoPageContainer.style.background = 'white';
                    videoPageContainer.style.padding = '40px';
                    videoPageContainer.style.position = 'absolute';
                    videoPageContainer.style.left = '-9999px';
                    videoPageContainer.style.fontFamily = "'Noto Sans KR', sans-serif";
                    
                    videoPageContainer.innerHTML = `
                        <div style="background: white; padding: 30px;">
                            <h2 style="color: #667eea; font-size: 2em; margin-bottom: 20px; border-bottom: 3px solid #667eea; padding-bottom: 15px;">
                                üé• Video Resources for Practice
                            </h2>
                            <p style="font-size: 1.1em; color: #666; margin-bottom: 10px; line-height: 1.8;">
                                Video links for characters that need practice:
                            </p>
                            <p style="font-size: 1em; color: #F57C00; margin-bottom: 50px; line-height: 1.8;">
                                (These characters scored below 10/10 and can benefit from extra practice)
                            </p>
                            
                            <div style="display: grid; gap: 45px;">
                                ${charactersNeedingVideos.map((item, index) => `
                                    <div style="background: #f8f9fa; padding: 25px; border-radius: 10px; border-left: 4px solid ${getScoreColorHex(item.score)}; margin-bottom: 5px;">
                                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                                            <div>
                                                <span style="font-size: 2.2em; font-weight: 600; color: #333; margin-right: 20px;">${item.char}</span>
                                                <span style="font-size: 1.3em; color: #666;">Current Score: <strong style="color: ${getScoreColorHex(item.score)};">${item.score.toFixed(1)}/10</strong></span>
                                            </div>
                                        </div>
                                        <div style="margin-top: 12px; font-size: 1em; color: #667eea; word-break: break-all; font-weight: 600; line-height: 1.6;">
                                            ${item.url}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(videoPageContainer);
                    await new Promise(resolve => setTimeout(resolve, 300));
                    
                    const videoCanvas = await html2canvas(videoPageContainer, {
                        scale: scale,
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: '#ffffff',
                        logging: false,
                        windowWidth: 1200
                    });
                    
                    document.body.removeChild(videoPageContainer);
                    
                    const videoImgData = videoCanvas.toDataURL('image/png', 1.0);
                    const videoImgHeightMM = videoCanvas.height / pxPerMM;
                    
                    let videoY = 0;
                    let videoRemaining = videoImgHeightMM;
                    
                    while (videoRemaining > 0) {
                        const videoPageCanvas = document.createElement('canvas');
                        videoPageCanvas.width = videoCanvas.width;
                        const availableHeight = pageHeight - (2 * margin);
                        const pageHeightPx = Math.min(videoRemaining * pxPerMM, availableHeight * pxPerMM);
                        videoPageCanvas.height = pageHeightPx;
                        const videoPageCtx = videoPageCanvas.getContext('2d');
                        
                        videoPageCtx.imageSmoothingEnabled = true;
                        videoPageCtx.imageSmoothingQuality = 'high';
                        
                        videoPageCtx.drawImage(
                            videoCanvas,
                            0, videoY * pxPerMM,
                            videoCanvas.width, pageHeightPx,
                            0, 0,
                            videoCanvas.width, pageHeightPx
                        );
                        
                        const videoPageImg = videoPageCanvas.toDataURL('image/png', 1.0);
                        pdf.addPage();
                        
                        const imgHeight = Math.min(availableHeight, videoRemaining);
                        pdf.addImage(videoPageImg, 'PNG', margin, margin, contentWidth, imgHeight);
                        
                        videoY += availableHeight;
                        videoRemaining -= availableHeight;
                    }
                }

                pdf.save(`${studentName}_Progress_Report.pdf`);

                if (downloadBtn) {
                    downloadBtn.style.display = 'flex';
                }
                
                if (statusEl) {
                    statusEl.textContent = `‚úÖ Download complete!`;
                    setTimeout(() => { statusEl.style.display = 'none'; }, 3000);
                }
            } catch (e) {
                console.error('PDF Generation Error:', e);
                alert('Error generating PDF. Please try again.');
                if (statusEl) statusEl.style.display = 'none';
                if (downloadBtn) downloadBtn.style.display = 'flex';
            }
        }

        function generateCharacterCardsForPDF(data) {
            const isDaily = analysisMode === 'daily';
            const isComparison = analysisMode === 'comparison';
            
            const dailyWeekIndex = isDaily ? getDailyWeekIndex(data) : 0;
            
            return data.characters.map(char => {
                const improvement = data.characterImprovements[char];
                
                if (isDaily) {
                    const weekScore = data.scores[char][dailyWeekIndex];
                    
                    if (weekScore === null || weekScore === undefined) {
                        return `
                            <div style="background: #e0e0e0; border: 2px solid #999; padding: 15px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 2em; color: #666; margin-bottom: 10px;">${char}</div>
                                <div style="font-size: 0.85em; color: #999;">No Data</div>
                            </div>
                        `;
                    }
                    
                    const borderColor = getScoreColorHex(weekScore);
                    
                    return `
                        <div style="background: white; border: 2px solid ${borderColor}; padding: 15px; border-radius: 10px; text-align: center;">
                            ${getMasteryHeader(weekScore)}
                            <div style="font-size: 2em; margin-bottom: 10px;">${char}</div>
                            <div style="font-size: 0.85em; color: #666;">Score: ${weekScore.toFixed(1)}/10</div>
                        </div>
                    `;
                }
                
                if (!improvement.hasData) {
                    return `
                        <div style="background: #e0e0e0; border: 2px solid #999; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 2em; color: #666; margin-bottom: 10px;">${char}</div>
                            <div style="font-size: 0.85em; color: #999;">No Data</div>
                        </div>
                    `;
                }
                
                const finalScore = improvement.end;
                const borderColor = getScoreColorHex(finalScore);
                
                if (isComparison) {
                    const currentIndex = data.weeks.length - 1;
                    let compareIndex = 0;
                    
                    if (comparisonType === 'day1') {
                        compareIndex = 0;
                    } else if (comparisonType === 'month') {
                        compareIndex = Math.max(0, currentIndex - 4);
                    } else if (comparisonType === 'week') {
                        compareIndex = Math.max(0, currentIndex - 1);
                    }
                    
                    const oldScore = data.scores[char][compareIndex];
                    const newScore = data.scores[char][currentIndex];
                    const change = newScore !== null && oldScore !== null ? newScore - oldScore : null;
                    
                    return `
                        <div style="background: white; border: 2px solid ${borderColor}; padding: 15px; border-radius: 10px; text-align: center;">
                            ${getMasteryHeader(newScore)}
                            <div style="font-size: 2em; margin-bottom: 10px;">${char}</div>
                            <div style="font-size: 0.85em; color: #666; line-height: 1.5;">
                                <div>Was: ${oldScore !== null ? oldScore.toFixed(1) : 'N/A'}/10</div>
                                <div>Now: ${newScore !== null ? newScore.toFixed(1) : 'N/A'}/10</div>
                            </div>
                            ${change !== null ? `
                                <div style="font-size: 1.1em; font-weight: 600; margin-top: 8px; color: ${change >= 0 ? '#38ef7d' : '#f45c43'};">
                                    ${change >= 0 ? '+' : ''}${change.toFixed(1)}
                                </div>
                            ` : ''}
                        </div>
                    `;
                } else {
                    const improvementColor = getScoreColorHex(finalScore);
                    return `
                        <div style="background: white; border: 2px solid ${borderColor}; padding: 15px; border-radius: 10px; text-align: center;">
                            ${getMasteryHeader(finalScore)}
                            <div style="font-size: 2em; margin-bottom: 10px;">${char}</div>
                            <div style="font-size: 0.85em; color: #666; line-height: 1.5;">
                                <div>Start: ${improvement.start.toFixed(1)}/10</div>
                                <div>Now: ${improvement.end.toFixed(1)}/10</div>
                            </div>
                            <div style="font-size: 1.1em; font-weight: 600; margin-top: 8px; color: ${improvementColor};">
                                ${improvement.improvement >= 0 ? '+' : ''}${improvement.improvement.toFixed(1)}
                            </div>
                        </div>
                    `;
                }
            }).join('');
        }
    </script>
</body>
</html>
